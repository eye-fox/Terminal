name: Build Universal APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ✅ Setup Java (modern & clean)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # ✅ Install required system tools
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y unzip zipalign apksigner curl

      # ✅ Install Apktool 2.12.0 (latest stable)
      - name: Install Apktool 2.12.0
        run: |
          curl -L -o apktool.jar https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.12.0.jar
          curl -L -o apktool https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
          chmod +x apktool
          sudo mv apktool /usr/local/bin/
          sudo mv apktool.jar /usr/local/bin/

      # ✅ Extract split APK zip
      - name: Extract split zip
        run: |
          mkdir split
          unzip split.zip -d split

      # ✅ Decompile base
      - name: Decompile base APK
        run: |
          apktool d split/base.apk -o base

      # ✅ Disable split flag (important)
      - name: Disable split flag
        run: |
          sed -i 's/isSplitApk: true/isSplitApk: false/g' base/apktool.yml

      # ✅ Merge ABI + DPI + Language splits
      - name: Merge splits
        run: |
          for file in split/split_config*.apk; do
            apktool d "$file" -o temp
            if [ -d temp/lib ]; then
              mkdir -p base/lib
              cp -r temp/lib/* base/lib/
            fi
            if [ -d temp/res ]; then
              cp -r temp/res/* base/res/
            fi
            rm -rf temp
          done

      # ✅ Build using aapt2 (required for modern apps)
      - name: Build universal APK
        run: |
          apktool b base -o universal-unsigned.apk --use-aapt2

      # ✅ Generate debug keystore
      - name: Generate debug keystore
        run: |
          keytool -genkey -v -keystore debug.keystore \
          -storepass android \
          -alias androiddebugkey \
          -keypass android \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -dname "CN=Android,O=Android,C=US"

      # ✅ Align APK
      - name: Align APK
        run: |
          zipalign -v 4 universal-unsigned.apk universal-aligned.apk

      # ✅ Sign APK
      - name: Sign APK
        run: |
          apksigner sign \
          --ks debug.keystore \
          --ks-pass pass:android \
          --key-pass pass:android \
          universal-aligned.apk

      # ✅ Verify signature
      - name: Verify APK
        run: |
          apksigner verify universal-aligned.apk

      # ✅ Upload result
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: universal-apk
          path: universal-aligned.apk
